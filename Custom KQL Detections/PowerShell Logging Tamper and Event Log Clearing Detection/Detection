DeviceProcessEvents
| where FileName in~ ("powershell.exe", "pwsh.exe")
| where ProcessCommandLine has_any (
"Set-ItemProperty",
"EnableScriptBlockLogging",
"EnableModuleLogging",
"EnableTranscripting",
"wevtutil cl",
"Clear-EventLog",
"SaveNothing",
"HistorySaveStyle",
"Set-PSReadlineOption"
)
or ProcessCommandLine matches regex @"(?i)[-/]e(nc(odedcommand)?)?[\s]+[A-Za-z0-9+/]{20,}={0,2}"
or ProcessCommandLine matches regex @"(?i)FromBase64String"
or ProcessCommandLine matches regex @"[A-Za-z0-9+/]{100,}={0,2}"
| extend SuspiciousActivity = case(
ProcessCommandLine has "SaveNothing", "History Clearing",
ProcessCommandLine has "EnableScriptBlockLogging", "Script Block Logging Tampering",
ProcessCommandLine has "EnableModuleLogging", "Module Logging Tampering",
ProcessCommandLine has "EnableTranscripting", "Transcription Tampering",
ProcessCommandLine has "wevtutil cl", "Event Log Clearing",
ProcessCommandLine has "Clear-EventLog", "Event Log Clearing",
ProcessCommandLine matches regex @"(?i)[-/]e(nc(odedcommand)?)?[\s]+[A-Za-z0-9+/]{20,}={0,2}", "Base64 Encoded Command",
ProcessCommandLine matches regex @"(?i)FromBase64String", "Base64 Decoding",
ProcessCommandLine matches regex @"[A-Za-z0-9+/]{100,}={0,2}", "Potential Base64 Content",
"Unknown"
)
| project
TimeGenerated,
DeviceName,
AccountName,
FileName,
ProcessCommandLine,
SuspiciousActivity,
InitiatingProcessFileName,
InitiatingProcessCommandLine,
InitiatingProcessAccountName
| sort by TimeGenerated desc
